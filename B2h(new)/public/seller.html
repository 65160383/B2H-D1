<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B2H ‚Äî ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f8f9fa}</style>
  <style>
    .fav-icon { width:18px;height:18px;vertical-align:middle;margin-right:6px }
    .fav-on { fill:#e74c3c; stroke:#e74c3c }
    .fav-off { fill:#ffffff; stroke:#e74c3c }
    @media (max-width:576px) { .fav-text { display:none } }
  </style>
</head>

<body>
  <nav class="navbar navbar-light bg-white shadow-sm">
      <div class="container">
      <a class="navbar-brand" href="/dashboard.html">B2H</a>
      <div class="d-flex align-items-center">
        <div id="sellerNav" class="me-3"></div>
        <div id="sellerControls"></div>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="mb-3">
      <h3 id="sellerTitle">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
    </div>

    <div id="sellerProducts" class="row g-3"></div>

    <!-- Product Detail Modal -->
    <div class="modal fade" id="productDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="detailImages" class="mb-2 d-flex flex-wrap gap-2"></div>
            <p class="mb-2"><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <span id="detailProductTitle"></span></p>
            <p class="mb-1"><strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> <span id="detailCategory"></span></p>
            <p class="mb-1"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> <span id="detailPrice"></span></p>
            <p class="mb-1"><strong>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <span id="detailContact"></span></p>
            <hr>
            <p class="mb-0" id="detailDescription"></p>
          </div>
          <div class="modal-footer">
            <div class="me-auto">
              <button id="detailEditBtn" type="button" class="btn btn-outline-secondary me-2" style="display:none;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button id="detailReviewBtn" type="button" class="btn btn-outline-success me-2" style="display:none;">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
              <button id="detailFavBtn" type="button" class="btn btn-outline-danger">
                <svg class="fav-icon fav-off" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 21s-7.5-4.9-10-7.3C-1 9.6 3 4 7.2 6.1 9.1 7.2 10 9 12 10.5c2-1.5 2.9-3.3 4.8-4.4C21 4 25 9.6 22 13.7 19.5 16.1 12 21 12 21z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="fav-text">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</span>
              </button>
            </div>
            <button id="detailDeleteBtn" type="button" class="btn btn-outline-danger me-2" style="display:none;">‡∏•‡∏ö</button>
            <button id="detailInterestBtn" type="button" class="btn btn-outline-primary me-2" style="display:none;">‡∏™‡∏ô‡πÉ‡∏à</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Interested Modal -->
  <div class="modal fade" id="interestedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="interestedList" class="list-group"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function escapeHtml(s) { return (s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function loadSeller(sellerId) {
      if (!sellerId) {
        document.getElementById('sellerTitle').textContent = '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        return;
      }
      try {
        const res = await fetch('/seller/' + encodeURIComponent(sellerId) + '/products');
        const data = await res.json();
        if (!data.success) {
          document.getElementById('sellerTitle').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ';
          return;
        }
        const seller = data.seller || {};
        const title = [seller.first_name, seller.last_name].filter(Boolean).join(' ') || seller.email || '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤';
        document.getElementById('sellerTitle').textContent = title;

        // seller nav: avatar + contact buttons
        const nav = document.getElementById('sellerNav');
        nav.innerHTML = '';
        if (seller && (seller.profile_image || seller.email)) {
          const avatar = seller.profile_image ? `<img src="${escapeHtml(seller.profile_image)}" alt="Avatar" style="width:40px;height:40px;object-fit:cover;border-radius:50%;margin-right:8px;">` : '';
          nav.innerHTML = `<div class="d-flex align-items-center">${avatar}<div><div class="fw-bold">${escapeHtml(title)}</div><div class="text-muted small">${escapeHtml(seller.email || '')}</div></div></div>`;
        }

        const container = document.getElementById('sellerProducts');
        container.innerHTML = '';
        const products = data.products || [];
        if (!products.length) {
          container.innerHTML = '<div class="col-12"><div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</div></div>';
          return;
        }

        products.forEach(item => {
          const col = document.createElement('div'); col.className = 'col-md-4';
          col.innerHTML = `
            <div class="card h-100 product-card" data-product-id="${escapeHtml(String(item.product_id))}" style="cursor:pointer;">
              ${item.img_url ? `<img src="${escapeHtml(item.img_url)}" class="card-img-top" style="object-fit:cover;height:200px;">` : ''}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${escapeHtml(item.title)}</h5>
                <p class="card-text text-muted mb-2 flex-grow-1">${escapeHtml(item.description || '')}</p>
                <p class="mb-1"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${escapeHtml(item.price)}</p>
                <p class="mb-0"><strong>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> ${escapeHtml(item.contact || '-')}</p>
              </div>
            </div>
          `;
          container.appendChild(col);
        });

        // click handler to open product detail modal
        container.addEventListener('click', (e) => {
          let el = e.target;
          while (el && el !== container && !el.classList.contains('product-card')) el = el.parentElement;
          if (el && el.classList.contains('product-card')) {
            const id = el.getAttribute('data-product-id');
            if (id) openProductDetail(id);
          }
        });
      } catch (err) {
        document.getElementById('sellerTitle').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î';
      }
    }

    const tokenKey = 'b2h_token';
    async function openProductDetail(productId) {
      if (!productId) return;
      try {
        const res = await fetch('/product/' + encodeURIComponent(productId));
        const data = await res.json();
        if (!data.success || !data.product) { alert(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
        const p = data.product;

        document.getElementById('detailTitle').textContent = (p.seller_name || '').trim() || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        document.getElementById('detailProductTitle').textContent = p.title || '-';
        document.getElementById('detailCategory').textContent = p.category || '-';
        document.getElementById('detailPrice').textContent = (p.price != null ? p.price : '-');
        document.getElementById('detailContact').textContent = p.contact || '-';
        document.getElementById('detailDescription').textContent = p.description || '';

        const imagesContainer = document.getElementById('detailImages');
        imagesContainer.innerHTML = '';
        const images = p.images || [];
        if (images.length) {
          images.forEach((url) => {
            const img = document.createElement('img');
            img.src = url; img.alt = 'Product image'; img.style.width = '150px'; img.style.height = '150px'; img.style.objectFit = 'cover'; img.className = 'border rounded';
            imagesContainer.appendChild(img);
          });
        } else if (p.img_url) {
          const img = document.createElement('img'); img.src = p.img_url; img.alt = 'Product image'; img.style.width = '150px'; img.style.height = '150px'; img.style.objectFit = 'cover'; img.className = 'border rounded'; imagesContainer.appendChild(img);
        } else {
          const span = document.createElement('span'); span.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'; imagesContainer.appendChild(span);
        }

        // favorite button state (heart icon + text)
        const favBtn = document.getElementById('detailFavBtn');
        let isFav = false;
        if (favBtn) {
          try {
            // If current user is the seller, hide favorite button (can't favorite own product)
            const meToken = localStorage.getItem(tokenKey);
            if (meToken) {
              try {
                const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + meToken } });
                const meData = await meRes.json();
                if (meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(p.seller_id)) {
                  favBtn.style.display = 'none';
                }
              } catch (e) {
                // ignore
              }
            }

            // If not hidden, proceed with regular favorite logic
            if (favBtn.style.display !== 'none') {
              const favIcon = favBtn.querySelector('.fav-icon');
              const favText = favBtn.querySelector('.fav-text');
              favBtn.disabled = true;
              if (favText) favText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
              try {
                const token = localStorage.getItem(tokenKey);
                if (token) {
                  const favRes = await fetch('/favorites', { headers: { 'Authorization': 'Bearer ' + token } });
                  const favData = await favRes.json();
                  if (favData.success && Array.isArray(favData.products)) {
                    isFav = favData.products.some(p => String(p.product_id) === String(productId));
                  }
                }
              } catch (e) {
                // ignore
              }
              favBtn.disabled = false;
              if (favText) favText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö';
              // keep heart icon appearance unchanged
              // toggle whole button color
              favBtn.classList.toggle('btn-danger', isFav);
              favBtn.classList.toggle('btn-outline-danger', !isFav);
              favBtn.onclick = async () => {
                const token = localStorage.getItem(tokenKey);
                if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }
                try {
                  favBtn.disabled = true;
                  if (favText) favText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô...';
                  const r = await fetch('/favorites/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                  const jr = await r.json();
                  if (jr.success) {
                    isFav = !!jr.added;
                    // keep heart icon appearance unchanged
                    // toggle whole button color
                    favBtn.classList.toggle('btn-danger', isFav);
                    favBtn.classList.toggle('btn-outline-danger', !isFav);
                    if (favText) favText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö';
                  } else {
                    alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
                  }
                } catch (err) {
                  alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                } finally {
                  favBtn.disabled = false;
                }
              };
            }
          } catch (e) {
            // fallback: show button
            favBtn.style.display = '';
          }
        }

        // Edit button: show (and redirect to dashboard edit) if current user is the seller
        const editBtn = document.getElementById('detailEditBtn');
        if (editBtn) {
          try {
            editBtn.style.display = 'none';
            const meToken = localStorage.getItem(tokenKey);
            if (meToken) {
              const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + meToken } });
              const meData = await meRes.json();
              if (meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(p.seller_id)) {
                editBtn.style.display = '';
                editBtn.onclick = () => {
                  window.location.href = `/dashboard.html?edit_product_id=${encodeURIComponent(productId)}`;
                };
              }
            }
          } catch (e) {
            editBtn.style.display = 'none';
          }
        }

        // Interest button: show for non-owner products and copy contact to clipboard
        const interestBtn = document.getElementById('detailInterestBtn');
        const reviewBtn = document.getElementById('detailReviewBtn');
        if (interestBtn) {
          try {
            interestBtn.style.display = 'none';
            const meToken = localStorage.getItem(tokenKey);
            if (meToken) {
              const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + meToken } });
              const meData = await meRes.json();
                if (!(meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(p.seller_id))) {
                interestBtn.style.display = '';
                interestBtn.onclick = async () => {
                  const token = localStorage.getItem(tokenKey);
                  if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }
                  try {
                      interestBtn.disabled = true;
                      const r = await fetch('/interests/add', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                      if (r.status === 404) {
                        const r2 = await fetch('/interests/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                        const jr2 = await r2.json();
                        if (jr2.success) {
                          alert(jr2.removed ? '‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        } else alert(jr2.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                      } else {
                        const jr = await r.json();
                        if (jr.success) {
                          if (jr.added) alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                          else alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                        } else {
                          alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                        }
                      }
                    } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                  finally { interestBtn.disabled = false; }
                };
              }
            } else {
              // not logged in: still allow user to view contact via prompt
              const contact = (p.contact || '').trim();
              if (contact) {
                interestBtn.style.display = '';
                interestBtn.onclick = () => { try { navigator.clipboard.writeText(contact); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ' + contact); } catch (e) { window.prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏µ‡πâ:', contact); } };
              }
            }
          } catch (e) {
            interestBtn.style.display = 'none';
          }
        }

        // Review button: show only if product is sold and current user is the buyer
        if (reviewBtn) {
          try {
            reviewBtn.style.display = 'none';
            const meToken = localStorage.getItem(tokenKey);
            if (meToken) {
              const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + meToken } });
              const meData = await meRes.json();
              if (meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(p.buyer_id) && p.status === 'sold') {
                reviewBtn.style.display = '';
                reviewBtn.onclick = async () => {
                  const ratingInput = prompt('‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (1-5)', '5');
                  if (ratingInput === null) return;
                  const rating = Number(ratingInput);
                  if (Number.isNaN(rating) || rating < 1 || rating > 5) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1 ‡∏ñ‡∏∂‡∏á 5'); return; }
                  const comment = prompt('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', '');
                  try {
                    reviewBtn.disabled = true;
                    const token = localStorage.getItem(tokenKey);
                    const res = await fetch('/product/' + encodeURIComponent(productId) + '/review', {
                      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                      body: JSON.stringify({ rating: rating, comment: comment })
                    });
                    const jr = await res.json();
                    if (jr.success) alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß'); else alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ');
                  } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                  finally { reviewBtn.disabled = false; }
                };
              }
            }
          } catch (e) { reviewBtn.style.display = 'none'; }
        }

        // Delete button: show for owner and attach handler (redirect or refresh seller list)
        const deleteBtn = document.getElementById('detailDeleteBtn');
        if (deleteBtn) {
          try {
            deleteBtn.style.display = 'none';
            const meToken = localStorage.getItem(tokenKey);
            if (meToken) {
              const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + meToken } });
              const meData = await meRes.json();
              if (meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(p.seller_id)) {
                deleteBtn.style.display = '';
                deleteBtn.onclick = async () => {
                  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                  try {
                    deleteBtn.disabled = true;
                    const token = localStorage.getItem(tokenKey);
                    const r = await fetch('/product/' + encodeURIComponent(productId), { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                    const jr = await r.json();
                    if (jr.success) {
                      const modalEl = document.getElementById('productDetailModal');
                      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                      modal.hide();
                      // reload seller products
                      loadSeller(getQueryParam('seller_id') || (meData.user && meData.user.user_id));
                    } else {
                      alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
                    }
                  } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö'); }
                  finally { deleteBtn.disabled = false; }
                };
              }
            }
          } catch (e) { deleteBtn.style.display = 'none'; }
        }

        const modalEl = document.getElementById('productDetailModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } catch (err) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      }
    }

    (async function(){
      let sellerId = getQueryParam('seller_id');
      // If no seller_id in query, try to use current logged-in user
      if (!sellerId) {
        try {
          const token = localStorage.getItem('b2h_token');
          if (token) {
            const res = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.loggedIn && data.user && data.user.user_id) {
              sellerId = String(data.user.user_id);
            }
          }
        } catch (e) {
          // ignore
        }
      }
      loadSeller(sellerId);
      try { renderSellerControls(sellerId); } catch (e) {}
    })();

    // Open interested modal for this seller (requires auth)
    async function openInterestedSeller(sellerId) {
      const token = localStorage.getItem(tokenKey);
      if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à'); return; }
      try {
        const res = await fetch('/seller/' + encodeURIComponent(sellerId) + '/interested', { headers: { 'Authorization': 'Bearer ' + token } });
        const data = await res.json();
        if (!data.success) { alert(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'); return; }
        const list = document.getElementById('interestedList'); list.innerHTML = '';
        const items = data.interested || [];
        if (!items.length) {
          list.innerHTML = '<div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>';
        } else {
          items.forEach(prod => {
            const item = document.createElement('div'); item.className = 'mb-3';
            const header = document.createElement('div'); header.className = 'fw-bold mb-1'; header.textContent = `${prod.title || ('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ ' + prod.product_id)} (${prod.users.length || 0})`;
            item.appendChild(header);
            const ul = document.createElement('div'); ul.className = 'list-group';
            (prod.users || []).forEach(u => {
              const uel = document.createElement('div'); uel.className = 'list-group-item d-flex align-items-center';
              const avatar = u.profile_image ? `<img src="${escapeHtml(u.profile_image)}" style="width:40px;height:40px;object-fit:cover;border-radius:50%;margin-right:8px;">` : `<div style="width:40px;height:40px;border-radius:50%;background:#ddd;margin-right:8px"></div>`;
              const contacts = [];
              if (u.contact_facebook) contacts.push('Facebook: ' + escapeHtml(u.contact_facebook));
              if (u.contact_line) contacts.push('LINE: ' + escapeHtml(u.contact_line));
              if (u.contact_instagram) contacts.push('IG: ' + escapeHtml(u.contact_instagram));
              const contactHtml = contacts.length ? `<div class="small mt-1 text-muted">${contacts.join(' | ')}</div>` : '';
              uel.innerHTML = `${avatar}<div><div class="fw-bold">${escapeHtml(u.name || u.email || '')}</div><div class="text-muted small">${escapeHtml(u.email || '')}</div>${contactHtml}</div>`;
              ul.appendChild(uel);
            });
            item.appendChild(ul);
            list.appendChild(item);
          });
        }
        const modalEl = document.getElementById('interestedModal'); const modal = new bootstrap.Modal(modalEl); modal.show();
      } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); }
    }

    // When loading seller, render '‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à' button for owner
    async function renderSellerControls(sellerId) {
      const container = document.getElementById('sellerControls');
      container.innerHTML = '';
      try {
        const token = localStorage.getItem(tokenKey);
        if (!token) return;
        const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
        const meData = await meRes.json();
      if (meData && meData.loggedIn && meData.user && String(meData.user.user_id) === String(sellerId)) {
        const btn = document.createElement('a'); btn.className = 'btn btn-outline-secondary me-2'; btn.id = 'interestedBtnSeller'; btn.textContent = 'üëÄ ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à';
        btn.href = `/interested.html?seller_id=${encodeURIComponent(sellerId)}`;
        container.appendChild(btn);
      }
      } catch (e) { /* ignore */ }
    }
  </script>
</body>

</html>
