<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>B2H — Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-3 text-center">เข้าสู่ระบบ</h4>
                        <form id="login" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="email" class="form-control" placeholder="๊Email" required>
                                <div class="invalid-feedback">กรุณากรอกอีเมลที่ถูกต้อง</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" id="password" class="form-control" placeholder="Password"
                                    required>
                                <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-primary" id="submitBtn" type="submit">
                                    <span id="btnText">Login</span>
                                    <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"
                                        role="status" aria-hidden="true"></span>
                                </button>
                            </div>
                        </form>
                        <div id="alertArea" class="mt-3"></div>
                        <hr>
                        <div class="text-center">
                            <button type="button" class="btn btn-link p-0" data-bs-toggle="modal"
                                data-bs-target="#registerModal">+ เพิ่มผู้ใช้ใหม่</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มผู้ใช้ใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label class="form-label">อีเมลมหาวิทยาลัย</label>
                            <input type="email" id="reg_email" class="form-control" required
                                placeholder="example@go.buu.ac.th">
                            <div class="invalid-feedback">กรุณากรอกอีเมลที่ถูกต้อง</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่าน</label>
                            <input type="password" id="reg_password" class="form-control" required>
                            <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ยืนยันรหัสผ่าน</label>
                            <input type="password" id="reg_password2" class="form-control" required>
                            <div class="invalid-feedback">กรุณายืนยันรหัสผ่านให้ตรงกัน</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชื่อ</label>
                            <input type="text" id="reg_first_name" class="form-control" placeholder="ชื่อ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">นามสกุล</label>
                            <input type="text" id="reg_last_name" class="form-control" placeholder="นามสกุล">
                        </div>
                        <div id="registerAlert" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button id="registerSubmit" type="button" class="btn btn-primary">บันทึกผู้ใช้</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const form = document.getElementById('login');
            const alertArea = document.getElementById('alertArea');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');

            function showAlert(type, msg) {
                alertArea.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!form.checkValidity()) { form.classList.add('was-validated'); return; }

                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                submitBtn.disabled = true; btnText.textContent = 'Signing in...'; btnSpinner.classList.remove('d-none');
                alertArea.innerHTML = '';

                try {
                    const res = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                    const data = await res.json();
                    if (res.status === 401 || res.status === 400) {
                        showAlert('danger', data.message || 'อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    } else if (data.success && data.token) {
                        localStorage.setItem('b2h_token', data.token);
                        window.location.href = '/dashboard.html';
                    } else {
                        showAlert('danger', data.message || 'เข้าสู่ระบบไม่สำเร็จ');
                    }
                } catch (err) {
                    showAlert('danger', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
                } finally {
                    submitBtn.disabled = false; btnText.textContent = 'Login'; btnSpinner.classList.add('d-none');
                }
            });

            // Register user
            const regForm = document.getElementById('registerForm');
            const regAlert = document.getElementById('registerAlert');
            const regSubmit = document.getElementById('registerSubmit');

            function showRegisterAlert(type, msg) {
                regAlert.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            }

            regSubmit.addEventListener('click', async () => {
                if (!regForm.checkValidity()) { regForm.classList.add('was-validated'); return; }

                const email = document.getElementById('reg_email').value.trim();
                const pw = document.getElementById('reg_password').value;
                const pw2 = document.getElementById('reg_password2').value;
                const firstName = document.getElementById('reg_first_name').value.trim();
                const lastName = document.getElementById('reg_last_name').value.trim();

                if (pw !== pw2) {
                    showRegisterAlert('danger', 'รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน');
                    return;
                }

                regSubmit.disabled = true;
                regAlert.innerHTML = '';

                try {
                    const res = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password: pw, first_name: firstName, last_name: lastName }),
                    });
                    const data = await res.json();
                    if (!data.success) {
                        showRegisterAlert('danger', data.message || 'ไม่สามารถเพิ่มผู้ใช้ได้');
                        return;
                    }
                    showRegisterAlert('success', 'เพิ่มผู้ใช้สำเร็จ สามารถเข้าสู่ระบบด้วยบัญชีนี้ได้');
                    regForm.reset();
                    regForm.classList.remove('was-validated');
                } catch (err) {
                    showRegisterAlert('danger', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
                } finally {
                    regSubmit.disabled = false;
                }
            });
        })();
    </script>
</body>

</html>