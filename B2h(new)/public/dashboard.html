<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>B2H ‚Äî Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa
        }
    </style>
    <style>
        .fav-icon { width:18px;height:18px;vertical-align:middle;margin-right:6px }
        .fav-on { fill:#e74c3c; stroke:#e74c3c }
        .fav-off { fill:#ffffff; stroke:#e74c3c }
        @media (max-width:576px) { .fav-text { display:none } }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">B2H</a>
            <div class="d-flex align-items-center">
                <img id="navAvatar" src="" alt="Avatar" class="rounded-circle" title="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
                    style="width:32px;height:32px;object-fit:cover;display:none;cursor:pointer;">
                <span id="navUser" class="ms-2 me-3 text-muted" style="cursor:pointer" title="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"></span>
                <button id="favoritesBtn" class="btn btn-outline-secondary btn-sm me-2" title="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö">‚ù§ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</button>
                <button id="logout" class="btn btn-outline-secondary btn-sm">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á</h3>
            <div>
                <button id="interestedBtn" class="btn btn-outline-secondary me-2" title="‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à">üëÄ ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</button>
                <button id="myProductsBtn" class="btn btn-outline-primary me-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#postModal">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
        </div>

        <div class="row">
            <!-- Left: Filters -->
            <aside class="col-md-3 mb-3">
                <div class="card p-3">
                    <h6 class="mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h6>
                    <div class="mb-3">
                        <div class="fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
                        <div id="filterCategories" class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" id="cat_books">
                                <label class="form-check-label" for="cat_books">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏≠‡∏ó‡∏µ" id="cat_it">
                                <label class="form-check-label" for="cat_it">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏≠‡∏ó‡∏µ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤" id="cat_clothes">
                                <label class="form-check-label" for="cat_clothes">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å" id="cat_dorm">
                                <label class="form-check-label" for="cat_dorm">‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞" id="cat_vehicle">
                                <label class="form-check-label" for="cat_vehicle">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°" id="cat_beauty">
                                <label class="form-check-label" for="cat_beauty">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡πÄ‡∏Å‡∏° / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á" id="cat_game">
                                <label class="form-check-label" for="cat_game">‡πÄ‡∏Å‡∏° / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-cat" type="checkbox" value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" id="cat_other">
                                <label class="form-check-label" for="cat_other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="fw-bold">‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                        <div class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_all" value="all" checked>
                                <label class="form-check-label" for="price_all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_0_100" value="0-100">
                                <label class="form-check-label" for="price_0_100">0 - 100</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_101_500" value="101-500">
                                <label class="form-check-label" for="price_101_500">101 - 500</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_501_1000" value="501-1000">
                                <label class="form-check-label" for="price_501_1000">501 - 1,000</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_1001_5000" value="1001-5000">
                                <label class="form-check-label" for="price_1001_5000">1,001 - 5,000</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priceRange" id="price_5001_plus" value="5001-">
                                <label class="form-check-label" for="price_5001_plus">5,001+</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button id="clearFilters" class="btn btn-sm btn-outline-secondary">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                    </div>
                </div>
            </aside>

            <!-- Right: Search + List -->
            <section class="col-md-9">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input id="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)">
                    </div>
                </div>

                <div id="list" class="row g-3"></div>
            </section>
        </div>
    </main>

        <!-- Interested Modal -->
        <div class="modal fade" id="interestedModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="interestedList" class="list-group"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Post Modal -->
    <div class="modal fade" id="postModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="postForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <input id="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="desc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <div class="row row-cols-1 row-cols-md-2 g-1">
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat1"
                                            value="‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" checked>
                                        <label class="form-check-label" for="cat1">1. ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat2"
                                            value="‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏≠‡∏ó‡∏µ">
                                        <label class="form-check-label" for="cat2">2. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏≠‡∏ó‡∏µ</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat3"
                                            value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤">
                                        <label class="form-check-label" for="cat3">3. ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat4"
                                            value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å">
                                        <label class="form-check-label" for="cat4">4. ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat5"
                                            value="‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞">
                                        <label class="form-check-label" for="cat5">5. ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat6"
                                            value="‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°">
                                        <label class="form-check-label" for="cat6">6. ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat7"
                                            value="‡πÄ‡∏Å‡∏° / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á">
                                        <label class="form-check-label" for="cat7">7. ‡πÄ‡∏Å‡∏° / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="category" id="cat8"
                                            value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">
                                        <label class="form-check-label" for="cat8">8. ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                                <input id="price" class="form-control" type="number" placeholder="0">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (LINE/Facebook)</label>
                                <input id="contact" class="form-control" placeholder="LINE ID ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏á‡∏Å‡πå Facebook/IG">
                                <div id="contactPresetButtons" class="mt-1 d-flex flex-wrap gap-2"></div>
                                <small class="text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label>
                            <input id="images" name="images" class="form-control" type="file" accept="image/*" multiple>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="savePost" type="button" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailImages" class="mb-2 d-flex flex-wrap gap-2"></div>
                    <p class="mb-2"><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <span id="detailProductTitle"></span></p>
                    <p class="mb-1"><strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> <span id="detailCategory"></span></p>
                    <p class="mb-1"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> <span id="detailPrice"></span></p>
                    <p class="mb-1"><strong>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <span id="detailContact"></span></p>
                    <hr>
                    <p class="mb-0" id="detailDescription"></p>
                </div>
                  <div class="modal-footer">
                            <div class="me-auto">
                                <button id="detailEditBtn" type="button" class="btn btn-outline-secondary me-2" style="display:none;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button id="detailMarkSoldBtn" type="button" class="btn btn-success me-2" style="display:none;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                                <button id="detailReviewBtn" type="button" class="btn btn-outline-success me-2" style="display:none;">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
                                <button id="detailFavBtn" type="button" class="btn btn-outline-danger">
                                    <svg class="fav-icon fav-off" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 21s-7.5-4.9-10-7.3C-1 9.6 3 4 7.2 6.1 9.1 7.2 10 9 12 10.5c2-1.5 2.9-3.3 4.8-4.4C21 4 25 9.6 22 13.7 19.5 16.1 12 21 12 21z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="fav-text">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</span>
                                </button>
                            </div>
                            <button id="detailDeleteBtn" type="button" class="btn btn-outline-danger me-2" style="display:none;">‡∏•‡∏ö</button>
                            <button id="detailInterestBtn" type="button" class="btn btn-outline-primary me-2" style="display:none;">‡∏™‡∏ô‡πÉ‡∏à</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                        </div>
            </div>
        </div>
    </div>
    
        <!-- Favorites Modal -->
        <div class="modal fade" id="favoritesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="favoritesList" class="row g-3"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="text-center mb-3">
                            <img id="profileImagePreview" src="" alt="Profile" class="rounded-circle mb-2"
                                style="width:96px;height:96px;object-fit:cover;display:none;">
                        </div>
                        <input type="hidden" id="profile_image">
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                            <input id="profile_image_file" class="form-control" type="file" accept="image/*">
                            <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input id="profile_first_name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input id="profile_last_name" class="form-control" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input id="profile_email" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Facebook</label>
                            <input id="contact_facebook" class="form-control" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ Facebook">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LINE</label>
                            <input id="contact_line" class="form-control" placeholder="LINE ID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instagram</label>
                            <input id="contact_instagram" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Instagram">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button id="saveProfile" type="button" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tokenKey = 'b2h_token';

        let currentUser = null;
        let products = [];
        let profileImageFile = null;
        let editProductId = null;

        function updateNavUserUI() {
            const emailSpan = document.getElementById('navUser');
            const avatarImg = document.getElementById('navAvatar');
            if (!currentUser) {
                emailSpan.textContent = '';
                avatarImg.style.display = 'none';
                return;
            }
            emailSpan.textContent = currentUser.email || '';
            const imgUrl = currentUser.profile_image || '';
            if (imgUrl) {
                avatarImg.src = imgUrl;
                avatarImg.style.display = 'inline-block';
            } else {
                avatarImg.style.display = 'none';
            }
        }
                // (removed stray global button logic) ‚Äî button visibility handled per-product inside openProductDetail

        function updateContactPresets() {
            const container = document.getElementById('contactPresetButtons');
            if (!container) return;
            container.innerHTML = '';
            if (!currentUser) return;

            const sources = [
                { key: 'contact_line', label: 'LINE' },
                { key: 'contact_facebook', label: 'Facebook' },
                { key: 'contact_instagram', label: 'Instagram' },
            ];

            const contactInput = document.getElementById('contact');

            sources.forEach(src => {
                const value = (currentUser[src.key] || '').trim();
                if (!value) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary btn-sm';
                btn.textContent = src.label;
                btn.addEventListener('click', () => {
                    if (contactInput) {
                        const part = `${src.label}: ${value}`;
                        const raw = (contactInput.value || '').trim();
                        let parts = raw ? raw.split(/\s*\|\s*/).filter(Boolean) : [];
                        const index = parts.indexOf(part);
                        if (index === -1) {
                            parts.push(part);
                        } else {
                            parts.splice(index, 1);
                        }
                        contactInput.value = parts.join(' | ');
                    }
                });
                container.appendChild(btn);
            });
        }

        async function checkAuth() {
            const token = localStorage.getItem(tokenKey);
            if (!token) return location.href = '/';
            const res = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (!data.loggedIn) { localStorage.removeItem(tokenKey); return location.href = '/'; }
            currentUser = data.user;
            updateNavUserUI();
            updateContactPresets();
        }

        function getActiveFilters() {
            // categories: array of selected category values
            const cats = Array.from(document.querySelectorAll('.filter-cat:checked')).map(el => el.value);
            const priceEl = document.querySelector('input[name="priceRange"]:checked');
            const priceRange = priceEl ? priceEl.value : 'all';
            return { categories: cats, priceRange };
        }

        function priceInRange(price, range) {
            if (range === 'all') return true;
            const p = Number(price);
            if (Number.isNaN(p)) return false;
            if (range === '0-100') return p >= 0 && p <= 100;
            if (range === '101-500') return p >= 101 && p <= 500;
            if (range === '501-1000') return p >= 501 && p <= 1000;
            if (range === '1001-5000') return p >= 1001 && p <= 5000;
            if (range === '5001-') return p >= 5001;
            return true;
        }

        function renderList(filter = '') {
            const container = document.getElementById('list'); container.innerHTML = '';
            const lower = (filter || '').toLowerCase();
            const active = getActiveFilters();

            const items = products.filter(i => {
                const text = ((i.title || '') + ' ' + (i.description || '')).toLowerCase();
                if (!text.includes(lower)) return false;
                // category filter
                if (active.categories && active.categories.length) {
                    const cat = (i.category || '').trim();
                    if (!cat || active.categories.indexOf(cat) === -1) return false;
                }
                // price filter
                if (!priceInRange(i.price, active.priceRange)) return false;
                return true;
            });

            if (!items.length) return container.innerHTML = '<div class="col-12"><div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></div>';
            items.forEach(item => {
                const col = document.createElement('div'); col.className = 'col-md-4';
                (function(){
                    // Map known status values to Thai labels. Show status badge for any status.
                    const statusMap = { 'available': '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢', 'reserved': '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'selling': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢', 'sold': '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' };
                    const status = (item.status !== undefined && item.status !== null) ? item.status : null;
                    const statusLabel = status ? (statusMap[String(status)] || escapeHtml(String(status))) : '';
                    const statusHtml = statusLabel ? `<div class="position-absolute bottom-0 end-0 m-2"><span class="badge bg-warning text-dark">${statusLabel}</span></div>` : '';
                    col.innerHTML = `
                        <div class="card h-100 product-card position-relative" data-product-id="${escapeHtml(String(item.product_id))}" style="cursor:pointer;">
                            ${item.img_url ? `<img src="${escapeHtml(item.img_url)}" class="card-img-top" style="object-fit:cover;height:200px">` : ''}
                            ${statusHtml}
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${escapeHtml(item.title)}</h5>
                                <p class="card-text text-muted mb-2 flex-grow-1">${escapeHtml(item.description || '')}</p>
                                <p class="mb-1"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${escapeHtml(item.price)}</p>
                                <p class="mb-0"><strong>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> ${escapeHtml(item.contact || '-')}</p>
                            </div>
                        </div>
                    `;
                })();
                container.appendChild(col);
            });
        }

        function escapeHtml(s) { return (s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

        async function loadProducts() {
            try {
                const res = await fetch('/products');
                const data = await res.json();
                if (data.success) {
                    products = data.products || [];
                } else {
                    products = [];
                }
            } catch (e) {
                products = [];
            }
            renderList(document.getElementById('search').value || '');
        }

        function openProfileModal() {
            if (!currentUser) return;
            const imgEl = document.getElementById('profileImagePreview');
            const imgUrl = currentUser.profile_image || '';
            if (imgUrl) {
                imgEl.src = imgUrl;
                imgEl.style.display = 'inline-block';
            } else {
                imgEl.style.display = 'none';
            }

            document.getElementById('profile_image').value = currentUser.profile_image || '';
            const fullName = (currentUser.name || '').trim();
            let first = '';
            let last = '';
            if (fullName) {
                const parts = fullName.split(/\s+/);
                first = parts.shift() || '';
                last = parts.join(' ');
            }
            document.getElementById('profile_first_name').value = first;
            document.getElementById('profile_last_name').value = last;
            document.getElementById('profile_email').value = currentUser.email || '';
            document.getElementById('contact_facebook').value = currentUser.contact_facebook || '';
            document.getElementById('contact_line').value = currentUser.contact_line || '';
            document.getElementById('contact_instagram').value = currentUser.contact_instagram || '';

            const modalEl = document.getElementById('profileModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        async function openProductDetail(productId) {
            if (!productId) return;
            try {
                const res = await fetch('/product/' + encodeURIComponent(productId));
                const data = await res.json();
                if (!data.success || !data.product) {
                    alert(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                    return;
                }
                const p = data.product;
                // Ensure we have currentUser (in case openProductDetail was called before auth finished)
                if (!currentUser) {
                    try {
                        const token = localStorage.getItem(tokenKey);
                        if (token) {
                            const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
                            const meData = await meRes.json();
                            if (meData && meData.loggedIn && meData.user) {
                                currentUser = meData.user;
                                try { updateNavUserUI(); updateContactPresets(); } catch(e) {}
                            }
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                // Show seller name with a link to the seller's shop page
                const sellerName = (p.seller_name || '').trim() || p.seller_email || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const sellerId = p.seller_id || '';
                const titleEl = document.getElementById('detailTitle');
                titleEl.innerHTML = `${escapeHtml(sellerName)} <a class="btn btn-sm btn-outline-primary ms-2" href="/seller.html?seller_id=${encodeURIComponent(sellerId)}">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>`;
                document.getElementById('detailProductTitle').textContent = p.title || '-';
                document.getElementById('detailCategory').textContent = p.category || '-';
                document.getElementById('detailPrice').textContent = (p.price != null ? p.price : '-');
                document.getElementById('detailContact').textContent = p.contact || '-';
                document.getElementById('detailDescription').textContent = p.description || '';

                const imagesContainer = document.getElementById('detailImages');
                imagesContainer.innerHTML = '';
                const images = p.images || [];
                if (images.length) {
                    images.forEach((url) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'Product image';
                        img.style.width = '150px';
                        img.style.height = '150px';
                        img.style.objectFit = 'cover';
                        img.className = 'border rounded';
                        imagesContainer.appendChild(img);
                    });
                } else if (p.img_url) {
                    const img = document.createElement('img');
                    img.src = p.img_url;
                    img.alt = 'Product image';
                    img.style.width = '150px';
                    img.style.height = '150px';
                    img.style.objectFit = 'cover';
                    img.className = 'border rounded';
                    imagesContainer.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                    imagesContainer.appendChild(span);
                }

                // Buttons: Edit / Interest / Delete ‚Äî visibility depends on whether current user is the seller
                    try {
                    const editBtn = document.getElementById('detailEditBtn');
                    if (editBtn) {
                        if (currentUser && currentUser.user_id && String(currentUser.user_id) === String(sellerId)) {
                            editBtn.style.display = '';
                            editBtn.onclick = () => openEditProduct(productId);
                        } else {
                            editBtn.style.display = 'none';
                        }
                    }

                    const markSoldBtn = document.getElementById('detailMarkSoldBtn');
                    if (markSoldBtn) {
                        if (currentUser && currentUser.user_id && String(currentUser.user_id) === String(sellerId)) {
                            markSoldBtn.style.display = '';
                            markSoldBtn.onclick = async () => {
                                if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?')) return;
                                const token = localStorage.getItem(tokenKey);
                                if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
                                try {
                                    markSoldBtn.disabled = true;
                                    const res = await fetch('/product/' + encodeURIComponent(productId) + '/status', {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                                        body: JSON.stringify({ status: 'sold' })
                                    });
                                    const jr = await res.json();
                                    if (jr.success) {
                                        const modalEl = document.getElementById('productDetailModal');
                                        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                        modal.hide();
                                        await loadProducts();
                                        alert('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤ "‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                                    } else {
                                        alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
                                    }
                                } catch (e) {
                                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                                } finally { markSoldBtn.disabled = false; }
                            };
                        } else {
                            markSoldBtn.style.display = 'none';
                        }
                    }

                    const interestBtn = document.getElementById('detailInterestBtn');
                    const reviewBtn = document.getElementById('detailReviewBtn');
                    if (interestBtn) {
                        // hide interest button if item is sold
                        if (p.status === 'sold') {
                            interestBtn.style.display = 'none';
                        } else if (currentUser && currentUser.user_id && String(currentUser.user_id) === String(sellerId)) {
                            interestBtn.style.display = 'none';
                        } else {
                            interestBtn.style.display = '';
                            // determine current interest state and update label
                            let isInterested = false;
                            interestBtn.disabled = true;
                            interestBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                            try {
                                const token = localStorage.getItem(tokenKey);
                                if (token) {
                                    const favRes = await fetch('/interests', { headers: { 'Authorization': 'Bearer ' + token } });
                                    const favData = await favRes.json();
                                    if (favData.success && Array.isArray(favData.products)) {
                                        isInterested = favData.products.some(p => String(p.product_id) === String(productId));
                                    }
                                }
                            } catch (e) {
                                // ignore
                            }
                            interestBtn.disabled = false;
                            interestBtn.textContent = isInterested ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ô‡πÉ‡∏à' : '‡∏™‡∏ô‡πÉ‡∏à';

                            interestBtn.onclick = async () => {
                                const token = localStorage.getItem(tokenKey);
                                if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }
                                try {
                                    interestBtn.disabled = true;
                                        if (isInterested) {
                                        // remove interest (toggle)
                                        const r = await fetch('/interests/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                                        const jr = await r.json();
                                        if (jr.success) {
                                            isInterested = false;
                                            interestBtn.textContent = '‡∏™‡∏ô‡πÉ‡∏à';
                                            // refresh product list so status badges update
                                            try { await loadProducts(); } catch(e) {}
                                            alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                                        } else {
                                            alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ');
                                        }
                                        } else {
                                        // add interest
                                        const r = await fetch('/interests/add', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                                        if (r.status === 404) {
                                            const r2 = await fetch('/interests/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                                            const jr2 = await r2.json();
                                            if (jr2.success) {
                                                isInterested = !jr2.removed;
                                                interestBtn.textContent = isInterested ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ô‡πÉ‡∏à' : '‡∏™‡∏ô‡πÉ‡∏à';
                                                alert(jr2.removed ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                                            } else alert(jr2.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                                        } else {
                                            const jr = await r.json();
                                            if (jr.success) {
                                                isInterested = !!jr.added;
                                                interestBtn.textContent = isInterested ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ô‡πÉ‡∏à' : '‡∏™‡∏ô‡πÉ‡∏à';
                                                if (jr.added) alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                                                else alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                                            } else {
                                                alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                                            }
                                        }
                                    }
                                } catch (e) {
                                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                                } finally { interestBtn.disabled = false; }
                            };
                        }
                    }

                    // Review button: show only if product status is 'sold' and current user is the buyer
                    if (reviewBtn) {
                        try {
                            reviewBtn.style.display = 'none';
                            if (p.status === 'sold' && currentUser && currentUser.user_id && String(currentUser.user_id) === String(p.buyer_id)) {
                                reviewBtn.style.display = '';
                                reviewBtn.onclick = async () => {
                                    const ratingInput = prompt('‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (1-5)', '5');
                                    if (ratingInput === null) return; // cancelled
                                    const rating = Number(ratingInput);
                                    if (Number.isNaN(rating) || rating < 1 || rating > 5) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1 ‡∏ñ‡∏∂‡∏á 5'); return; }
                                    const comment = prompt('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', '');
                                    const token = localStorage.getItem(tokenKey);
                                    if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
                                    try {
                                        reviewBtn.disabled = true;
                                        const res = await fetch('/product/' + encodeURIComponent(productId) + '/review', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                                            body: JSON.stringify({ rating: rating, comment: comment })
                                        });
                                        const jr = await res.json();
                                        if (jr.success) {
                                            alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                                        } else {
                                            alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ');
                                        }
                                    } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                                    finally { reviewBtn.disabled = false; }
                                };
                            }
                        } catch (e) { reviewBtn.style.display = 'none'; }
                    }

                    const deleteBtn = document.getElementById('detailDeleteBtn');
                    if (deleteBtn) {
                        if (currentUser && currentUser.user_id && String(currentUser.user_id) === String(sellerId)) {
                            deleteBtn.style.display = '';
                            deleteBtn.onclick = async () => {
                                if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                                const token = localStorage.getItem(tokenKey);
                                if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
                                try {
                                    deleteBtn.disabled = true;
                                    const r = await fetch('/product/' + encodeURIComponent(productId), { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                                    const jr = await r.json();
                                    if (jr.success) {
                                        const modalEl = document.getElementById('productDetailModal');
                                        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                        modal.hide();
                                        await loadProducts();
                                    } else {
                                        alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
                                    }
                                } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö'); }
                                finally { deleteBtn.disabled = false; }
                            };
                        } else {
                            deleteBtn.style.display = 'none';
                        }
                    }
                } catch (e) {
                    // ignore UI button setup errors
                }

                // favorite button state (heart icon + text)
                const favBtn = document.getElementById('detailFavBtn');
                let isFav = false;
                if (favBtn) {
                    // If current user is the seller, hide the favorite button (can't favorite own product)
                    try {
                        if (currentUser && currentUser.user_id && String(currentUser.user_id) === String(sellerId)) {
                            favBtn.style.display = 'none';
                        } else {
                            favBtn.style.display = '';
                            const favIcon = favBtn.querySelector('.fav-icon');
                            const favText = favBtn.querySelector('.fav-text');
                            favBtn.disabled = true;
                            if (favText) favText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                            try {
                                const token = localStorage.getItem(tokenKey);
                                if (token) {
                                    const favRes = await fetch('/favorites', { headers: { 'Authorization': 'Bearer ' + token } });
                                    const favData = await favRes.json();
                                    if (favData.success && Array.isArray(favData.products)) {
                                        isFav = favData.products.some(p => String(p.product_id) === String(productId));
                                    }
                                }
                            } catch (e) {
                                // ignore
                            }
                            favBtn.disabled = false;
                            if (favText) favText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö';
                            // update text and appearance
                            if (favText) favText.textContent = isFav ? '‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö';
                            favBtn.classList.toggle('btn-danger', isFav);
                            favBtn.classList.toggle('btn-outline-danger', !isFav);
                            // attach toggle handler
                            favBtn.onclick = async () => {
                                const token = localStorage.getItem(tokenKey);
                                if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }
                                try {
                                    favBtn.disabled = true;
                                    if (favText) favText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô...';
                                    const r = await fetch('/favorites/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: productId }) });
                                    const jr = await r.json();
                                        if (jr.success) {
                                        isFav = !!jr.added;
                                        if (favText) favText.textContent = isFav ? '‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö';
                                        favBtn.classList.toggle('btn-danger', isFav);
                                        favBtn.classList.toggle('btn-outline-danger', !isFav);
                                        try { await loadProducts(); } catch(e) {}
                                    } else {
                                        alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
                                    }
                                } catch (err) {
                                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                                } finally {
                                    favBtn.disabled = false;
                                }
                            };
                        }
                    } catch (e) {
                        // fallback: show button
                        favBtn.style.display = '';
                    }
                }

                const modalEl = document.getElementById('productDetailModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
            }
        }

        // Open post modal in edit mode for a product
        async function openEditProduct(productId) {
            if (!productId) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
            try {
                const res = await fetch('/product/' + encodeURIComponent(productId));
                const data = await res.json();
                if (!data.success || !data.product) {
                    alert(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                    return;
                }
                const p = data.product;
                document.getElementById('title').value = p.title || '';
                document.getElementById('desc').value = p.description || '';
                document.getElementById('price').value = (p.price != null ? p.price : '');
                document.getElementById('contact').value = p.contact || '';
                const catEl = document.querySelector('input[name="category"][value="' + (p.category || '') + '"]');
                if (catEl) catEl.checked = true;
                // clear file input
                const imagesInput = document.getElementById('images');
                if (imagesInput) imagesInput.value = null;

                editProductId = productId;
                const modalEl = document.getElementById('postModal');
                const modalTitle = modalEl.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
            }
        }

        document.getElementById('savePost').addEventListener('click', async () => {
            const title = document.getElementById('title').value.trim();
            if (!title) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
            const desc = document.getElementById('desc').value.trim();
            const price = document.getElementById('price').value.trim();
            if (!price) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤');
            const contact = document.getElementById('contact').value.trim();
            const categoryEl = document.querySelector('input[name="category"]:checked');
            const category = categoryEl ? categoryEl.value : '';
            const imagesInput = document.getElementById('images');

            const token = localStorage.getItem(tokenKey);
            if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà'); return location.href = '/'; }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', desc);
            formData.append('price', price);
            formData.append('contact', contact);
            formData.append('category', category);
            if (imagesInput && imagesInput.files) {
                for (const file of imagesInput.files) {
                    formData.append('images', file);
                }
            }

            try {
                const url = editProductId ? ('/product/' + encodeURIComponent(editProductId)) : '/product';
                const method = editProductId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                const data = await res.json();
                if (!data.success) {
                    alert(data.message || (editProductId ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ' : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ'));
                    return;
                }
                await loadProducts();
                const modalEl = document.getElementById('postModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                document.getElementById('postForm').reset();
                // reset edit state
                editProductId = null;
                const modalTitle = modalEl.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
            }
        });

        // Reset edit state when post modal is closed
        const postModalEl = document.getElementById('postModal');
        if (postModalEl) {
            postModalEl.addEventListener('hidden.bs.modal', () => {
                editProductId = null;
                document.getElementById('postForm').reset();
                const modalTitle = postModalEl.querySelector('.modal-title');
                if (modalTitle) modalTitle.textContent = '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            });
        }

        document.getElementById('list').addEventListener('click', (e) => {
            const container = e.currentTarget;
            let el = e.target;
            while (el && el !== container && !el.classList.contains('product-card')) {
                el = el.parentElement;
            }
            if (el && el.classList.contains('product-card')) {
                const id = el.getAttribute('data-product-id');
                if (id) openProductDetail(id);
            }
        });

        document.getElementById('navUser').addEventListener('click', openProfileModal);
        document.getElementById('navAvatar').addEventListener('click', openProfileModal);

        document.getElementById('profile_image_file').addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            profileImageFile = file || null;
            const imgEl = document.getElementById('profileImagePreview');
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    imgEl.src = reader.result;
                    imgEl.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            } else {
                const url = document.getElementById('profile_image').value.trim();
                if (url) {
                    imgEl.src = url;
                    imgEl.style.display = 'inline-block';
                } else {
                    imgEl.style.display = 'none';
                }
            }
        });

        document.getElementById('saveProfile').addEventListener('click', async () => {
            const token = localStorage.getItem(tokenKey);
            if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà'); return location.href = '/'; }

            const firstName = document.getElementById('profile_first_name').value.trim();
            const lastName = document.getElementById('profile_last_name').value.trim();
            const combinedName = (firstName + ' ' + lastName).trim();

            const body = {
                name: combinedName,
                profile_image: document.getElementById('profile_image').value.trim(),
                contact_facebook: document.getElementById('contact_facebook').value.trim(),
                contact_line: document.getElementById('contact_line').value.trim(),
                contact_instagram: document.getElementById('contact_instagram').value.trim(),
            };

            try {
                const res = await fetch('/me', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token,
                    },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                if (!data.success) {
                    alert(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
                    return;
                }
                currentUser = data.user;
                updateNavUserUI();
                updateContactPresets();

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà /me/avatar
                if (profileImageFile) {
                    const fd = new FormData();
                    fd.append('avatar', profileImageFile);
                    const avatarRes = await fetch('/me/avatar', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                        },
                        body: fd,
                    });
                    const avatarData = await avatarRes.json();
                    if (avatarData.success && avatarData.user) {
                        currentUser = avatarData.user;
                        document.getElementById('profile_image').value = currentUser.profile_image || '';
                        updateNavUserUI();
                        updateContactPresets();
                    } else if (!avatarData.success) {
                        alert(avatarData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
                        return;
                    }
                }

                const modalEl = document.getElementById('profileModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                profileImageFile = null;
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå');
            }
        });

        document.getElementById('search').addEventListener('input', (e) => renderList(e.target.value));

        // Wire filter inputs
        function setupFilterListeners() {
            const cats = Array.from(document.querySelectorAll('.filter-cat'));
            cats.forEach(el => el.addEventListener('change', () => renderList(document.getElementById('search').value || '')));
            const prices = Array.from(document.querySelectorAll('input[name="priceRange"]'));
            prices.forEach(el => el.addEventListener('change', () => renderList(document.getElementById('search').value || '')));
            const clearBtn = document.getElementById('clearFilters');
            if (clearBtn) clearBtn.addEventListener('click', () => {
                cats.forEach(c => c.checked = false);
                const pAll = document.getElementById('price_all'); if (pAll) pAll.checked = true;
                renderList(document.getElementById('search').value || '');
            });
        }

        document.getElementById('logout').addEventListener('click', async () => {
            localStorage.removeItem(tokenKey);
            await fetch('/logout', { method: 'POST' });
            location.href = '/';
        });

        // Favorites: open modal and load favorites
        async function openFavorites() {
            const token = localStorage.getItem(tokenKey);
            if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö'); return; }
            try {
                const res = await fetch('/favorites', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                if (!data.success) { alert(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ'); return; }
                const list = document.getElementById('favoritesList'); list.innerHTML = '';
                const items = data.products || [];
                if (!items.length) { list.innerHTML = '<div class="col-12"><div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</div></div>'; }
                items.forEach(item => {
                    const col = document.createElement('div'); col.className = 'col-md-4';
                    col.innerHTML = `
                        <div class="card h-100">
                            ${item.img_url ? `<img src="${escapeHtml(item.img_url)}" class="card-img-top" style="object-fit:cover;height:200px;">` : ''}
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${escapeHtml(item.title)}</h5>
                                <p class="card-text text-muted mb-2 flex-grow-1">${escapeHtml(item.description || '')}</p>
                                <p class="mb-1"><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${escapeHtml(item.price)}</p>
                                <div class="mt-2 d-flex gap-2">
                                    <button class="btn btn-sm btn-primary btn-view" data-id="${escapeHtml(String(item.product_id))}">‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                                    <button class="btn btn-sm btn-outline-danger btn-unfav" data-id="${escapeHtml(String(item.product_id))}">‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</button>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(col);
                });

                // attach handlers
                Array.from(document.querySelectorAll('.btn-view')).forEach(b => b.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    if (id) {
                        const modalEl = document.getElementById('favoritesModal');
                        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        modal.hide();
                        openProductDetail(id);
                    }
                }));

                Array.from(document.querySelectorAll('.btn-unfav')).forEach(b => b.addEventListener('click', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    if (!id) return;
                    try {
                        const r = await fetch('/favorites/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ product_id: id }) });
                        const jr = await r.json();
                        if (jr.success) {
                            // refresh favorites modal
                            openFavorites();
                        } else {
                            alert(jr.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ');
                        }
                    } catch (err) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                }));

                const modalEl = document.getElementById('favoritesModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö');
            }
        }

        document.getElementById('favoritesBtn').addEventListener('click', openFavorites);

        // My products button: go to seller page for current user
        document.getElementById('myProductsBtn').addEventListener('click', async () => {
            if (currentUser && currentUser.user_id) {
                return window.location.href = `/seller.html?seller_id=${encodeURIComponent(currentUser.user_id)}`;
            }
            const token = localStorage.getItem(tokenKey);
            if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
            try {
                const res = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                if (data && data.user && data.user.user_id) {
                    window.location.href = `/seller.html?seller_id=${encodeURIComponent(data.user.user_id)}`;
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                }
            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        });

        // Init
        (async () => {
            await checkAuth();
            await loadProducts();
            setupFilterListeners();
            // If opened with ?edit_product_id=..., open edit modal
            try {
                const params = new URLSearchParams(window.location.search);
                const editId = params.get('edit_product_id');
                if (editId) {
                    // ensure auth loaded
                    await openEditProduct(editId);
                }
            } catch (e) {
                // ignore
            }
        })();

        // Open interested modal for current user's products
        async function openInterested() {
            const token = localStorage.getItem(tokenKey);
            if (!token) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à'); return; }
            try {
                // get current user id
                const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
                const meData = await meRes.json();
                if (!meData.loggedIn || !meData.user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
                const sellerId = meData.user.user_id;
                const res = await fetch('/seller/' + encodeURIComponent(sellerId) + '/interested', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                if (!data.success) { alert(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'); return; }
                const list = document.getElementById('interestedList');
                list.innerHTML = '';
                const items = data.interested || [];
                if (!items.length) {
                    list.innerHTML = '<div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>';
                } else {
                    items.forEach(prod => {
                        const item = document.createElement('div');
                        item.className = 'mb-3';
                        const header = document.createElement('div');
                        header.className = 'fw-bold mb-1';
                        header.textContent = `${prod.title || ('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ ' + prod.product_id)} (${prod.users.length || 0})`;
                        item.appendChild(header);
                        const ul = document.createElement('div');
                        ul.className = 'list-group';
                        (prod.users || []).forEach(u => {
                            const uel = document.createElement('div');
                            uel.className = 'list-group-item d-flex align-items-center';
                            const avatar = u.profile_image ? `<img src="${escapeHtml(u.profile_image)}" style="width:40px;height:40px;object-fit:cover;border-radius:50%;margin-right:8px;">` : `<div style="width:40px;height:40px;border-radius:50%;background:#ddd;margin-right:8px"></div>`;
                            const contacts = [];
                            if (u.contact_facebook) contacts.push('Facebook: ' + escapeHtml(u.contact_facebook));
                            if (u.contact_line) contacts.push('LINE: ' + escapeHtml(u.contact_line));
                            if (u.contact_instagram) contacts.push('IG: ' + escapeHtml(u.contact_instagram));
                            const contactHtml = contacts.length ? `<div class="small mt-1 text-muted">${contacts.join(' | ')}</div>` : '';
                            uel.innerHTML = `${avatar}<div><div class="fw-bold">${escapeHtml(u.name || u.email || '')}</div><div class="text-muted small">${escapeHtml(u.email || '')}</div>${contactHtml}</div>`;
                            ul.appendChild(uel);
                        });
                        item.appendChild(ul);
                        list.appendChild(item);
                    });
                }
                        const modalEl = document.getElementById('interestedModal');
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
            } catch (e) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

                // Also allow opening the full page view
                document.getElementById('interestedBtn').addEventListener('click', () => {
                    const token = localStorage.getItem(tokenKey);
                    if (!token) return location.href = '/interested.html';
                    // try to get user id then navigate
                    (async () => {
                        try {
                            const meRes = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
                            const meData = await meRes.json();
                            if (meData && meData.loggedIn && meData.user && meData.user.user_id) {
                                window.location.href = `/interested.html?seller_id=${encodeURIComponent(meData.user.user_id)}`;
                            } else {
                                window.location.href = '/interested.html';
                            }
                        } catch (e) { window.location.href = '/interested.html'; }
                    })();
                });
    </script>

</body>

</html>