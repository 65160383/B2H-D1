<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B2H — คนที่สนใจสินค้า</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f8f9fa}</style>
  <style>
    .avatar { width:48px;height:48px;object-fit:cover;border-radius:50%;margin-right:12px }
  </style>
</head>

<body>
  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="/dashboard.html">B2H</a>
      <div id="navRight"></div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">คนที่สนใจสินค้าของฉัน</h3>
      <div>
        <a id="backBtn" class="btn btn-outline-secondary" href="/dashboard.html">← กลับ</a>
      </div>
    </div>

    <div id="content"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function escapeHtml(s) { return (s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function getQueryParam(name) { return new URLSearchParams(window.location.search).get(name); }

    async function loadInterested(sellerId) {
      const container = document.getElementById('content');
      container.innerHTML = '';
      if (!sellerId) return container.innerHTML = '<div class="alert alert-warning">ไม่พบผู้ขาย</div>';
      try {
        const token = localStorage.getItem('b2h_token');
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        const res = await fetch('/seller/' + encodeURIComponent(sellerId) + '/interested', { headers });
        const data = await res.json();
        if (!data.success) return container.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.message||'ไม่สามารถโหลดข้อมูลได้')}</div>`;

        // Only show products that are currently available — skip reserved/sold/etc.
        const items = (data.interested || []).filter(it => String(it.product_status || 'available') === 'available');
        if (!items.length) return container.innerHTML = '<div class="alert alert-info">ยังไม่มีใครแสดงความสนใจในสินค้าที่พร้อมขาย</div>';

        items.forEach(prod => {
          const card = document.createElement('div');
          card.className = 'card mb-3';
          const body = document.createElement('div'); body.className = 'card-body';
            const header = document.createElement('div'); header.className = 'd-flex justify-content-between align-items-center mb-2';
            const left = document.createElement('div'); left.className = 'd-flex align-items-center';
            if (prod.product_img) {
              const pi = document.createElement('img'); pi.src = prod.product_img; pi.style.width='72px'; pi.style.height='72px'; pi.style.objectFit='cover'; pi.style.borderRadius='6px'; pi.style.marginRight='12px'; left.appendChild(pi);
            }
            const title = document.createElement('div'); title.className = 'fw-bold'; title.textContent = prod.title || ('สินค้ารหัส ' + prod.product_id);
            left.appendChild(title);
            const count = document.createElement('div'); count.className = 'text-muted small'; count.textContent = (prod.users && prod.users.length ? (prod.users.length + ' คน') : '0 คน');
            header.appendChild(left); header.appendChild(count);
          body.appendChild(header);

          const list = document.createElement('div');
          (prod.users || []).forEach(u => {
            const row = document.createElement('div'); row.className = 'd-flex align-items-center py-2 border-top';
            const avatarHtml = u.profile_image ? `<img src="${escapeHtml(u.profile_image)}" class="avatar">` : `<div style="width:48px;height:48px;border-radius:50%;background:#ddd;margin-right:12px"></div>`;
            const info = document.createElement('div'); info.className = 'flex-grow-1';
            const name = document.createElement('div'); name.className = 'fw-bold'; name.textContent = u.name || u.email || '';
            const email = document.createElement('div'); email.className = 'text-muted small'; email.textContent = u.email || '';
            const contacts = [];
            if (u.contact_facebook) contacts.push('Facebook: ' + u.contact_facebook);
            if (u.contact_line) contacts.push('LINE: ' + u.contact_line);
            if (u.contact_instagram) contacts.push('IG: ' + u.contact_instagram);
            const contactDiv = document.createElement('div'); contactDiv.className = 'small text-muted mt-1'; contactDiv.textContent = contacts.join(' | ');
            info.appendChild(name); info.appendChild(email); if (contacts.length) info.appendChild(contactDiv);

            const right = document.createElement('div'); right.className = 'ms-3';
            // Accept button: owner can accept this interested user to mark product as selling
            if (prod.product_status === 'selling') {
              const lbl = document.createElement('span'); lbl.className = 'badge bg-warning text-dark'; lbl.textContent = 'กำลังขาย'; right.appendChild(lbl);
            } else {
              const acceptBtn = document.createElement('button'); acceptBtn.className = 'btn btn-sm btn-success'; acceptBtn.textContent = 'ยอมรับ';
              acceptBtn.onclick = async () => {
                if (!confirm('ยืนยันรับผู้ซื้อสำหรับสินค้านี้?')) return;
                try {
                  const token = localStorage.getItem('b2h_token');
                  if (!token) { alert('กรุณาเข้าสู่ระบบ'); return; }
                  acceptBtn.disabled = true;
                  const res = await fetch('/product/' + encodeURIComponent(prod.product_id) + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ status: 'reserved', buyer_id: u.user_id })
                  });
                  const jr = await res.json();
                  if (jr.success) {
                    alert('ยืนยันผู้ซื้อเรียบร้อยแล้ว');
                    await loadInterested(getQueryParam('seller_id'));
                  } else {
                    alert(jr.message || 'ไม่สามารถยืนยันได้');
                  }
                } catch (e) { alert('เกิดข้อผิดพลาด'); }
                finally { acceptBtn.disabled = false; }
              };
              right.appendChild(acceptBtn);
            }

            row.innerHTML = avatarHtml; row.appendChild(info); row.appendChild(right);
            list.appendChild(row);
          });

          body.appendChild(list);
          card.appendChild(body);
          document.getElementById('content').appendChild(card);
        });

      } catch (e) {
        container.innerHTML = '<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
      }
    }

    (async function(){
      let sellerId = getQueryParam('seller_id');
      if (!sellerId) {
        const token = localStorage.getItem('b2h_token');
        if (token) {
          try {
            const res = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.loggedIn && data.user && data.user.user_id) sellerId = String(data.user.user_id);
          } catch(e){}
        }
      }
      await loadInterested(sellerId);
    })();
  </script>
</body>

</html>
